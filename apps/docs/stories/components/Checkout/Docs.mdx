import {
  Meta,
  Title,
  Subtitle,
  Description,
  ArgTypes,
  Source,
} from '@storybook/blocks';
import example from './example';
import {
  AuthTokenDescription,
  ComponentBox,
} from '../../utils/documentation-components.tsx';
import * as JustifiCheckout from './index.stories.tsx';
import { setUpMocks } from '../../utils/mockAllServices';

{setUpMocks()}

<Meta
  title="Payment Facilitation/Payments/Checkout"
  Components="justifi-checkout"
  of={JustifiCheckout}
/>

<Title />

---

Component to render the necessary fields to enter proper payment method information and process a payment.
You will need to first create a checkout via [Checkout API](https://docs.justifi.tech/api-spec#tag/Checkouts) to get the `checkout-id` required for this component.

# Index

---

- [Props, events and methods](#props-events-and-methods)
- [Authorization](#authorization)
- [Security](#security)
- [Example usage](#example-usage)

- [Pre-Complete Hook](#pre-complete-hook)

- [Payment methods](#payment-methods)

# Props, events and methods

---

<ArgTypes exclude={['Theme']} />

# Pre-Complete Hook

---

You can provide a `preCompleteHook` function to inspect the checkout state before submission proceeds. This is useful for implementing custom validation, user confirmation dialogs, or conditional payment restrictions based on business rules.

The hook runs after validation and payment method tokenization (including Plaid exchange when applicable), and before the checkout is completed, so the state includes the latest values such as `paymentToken` when available.

The hook receives three parameters:

- `state`: A `CheckoutState` object containing the current checkout information
- `resolve`: A function to call to proceed with submission
- `reject`: A function to call to stop submission

```javascript
const checkout = document.querySelector('justifi-checkout');

/**
 * CheckoutState example (shape):
 * {
 *   selectedPaymentMethod: { id?: string, type: 'new_card' | 'apple_pay' | 'google_pay' | ... } | undefined,
 *   paymentAmount: 5000,
 *   totalAmount: 5000,
 *   paymentCurrency: 'USD',
 *   paymentDescription: 'Order #123',
 *   savedPaymentMethods: [],
 *   savePaymentMethod: false,
 *   bnplEnabled: false,
 *   applePayEnabled: true,
 *   insuranceEnabled: false,
 *   disableBankAccount: false,
 *   disableCreditCard: false,
 *   disablePaymentMethodGroup: false,
 *   paymentToken: 'pm_123' // tokenized payment method id; Apple Pay, Google Pay and Plaid set this too (paymentMethodId)
 * }
 */
checkout.preCompleteHook = (state, resolve, reject) => {
  // Example: Require confirmation for large payments
  if (state.totalAmount > 100000) {
    const confirmed = confirm(
      `Confirm payment of $${(state.totalAmount / 100).toFixed(2)}?`,
    );
    if (confirmed) {
      resolve(state);
    } else {
      reject();
    }
  } else {
    resolve(state);
  }
};
```

> Important: Assign the hook as a JavaScript property on the element (e.g., `checkout.preCompleteHook = fn`). Do not pass it as an HTML attribute (e.g., `pre-complete-hook="..."`); functions must be set on properties, not attributes.

# Payment methods

---

The Unified Checkout automatically displays additional payment method options when they are enabled in your account settings and when device/browser or other eligibility constraints are met:

- **Apple Pay**: Must be enabled in account settings. It renders automatically only on eligible devices/browsers; otherwise it will not appear.
- **Sezzle (BNPL)**: Must be enabled in account settings. It displays automatically when available for the account.
- **Plaid (Bank account verification)**: Must be enabled in account settings. It displays automatically when bank account payments with Plaid verification are enabled.

No extra component configuration is required beyond enabling these features on the account. When unavailable or ineligible, these options are simply not shown.

# Authorization

---

Web Component Token: These tokens are generated by your backend services using the [Web Component Tokens API](https://docs.justifi.tech/api-spec#tag/Web-Component-Tokens).
Each token can be scoped to perform a set number of actions and is active for 60 minutes.
When creating a web component token for this specific component you'll need to use the following roles:

<ul>
  <li>
    `write:checkout:checkout_id` - use the `checkout_id` you receive when you
    create a checkout via [Checkout
    API](https://docs.justifi.tech/api-spec#tag/Checkouts)
  </li>
  <li>
    `write:tokenize:account_id` - use the `account_id` you pass to the checkout
    API
  </li>
</ul>

# Security

---

The api endpoint associated with this component has the following security measures in place:

1. **Rate Limiting**: POST requests to are limited to 2 requests per 10 seconds.
2. **Token-based Request Limiting**: POST requests using web component token authentication are limited to 10 attempts per token.

These measures are in place to prevent abuse and ensure the security of the payment processing system.

# Example Usage

---

<ComponentBox>
  <justifi-checkout account-id="123" auth-token="123abc" checkout-id="123" />
</ComponentBox>

---

<Source dark language="html" code={example} />
